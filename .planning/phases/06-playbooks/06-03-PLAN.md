---
phase: 06-playbooks
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/playbooks/playbook-section.tsx
  - src/components/playbooks/generate-playbook-button.tsx
  - src/app/(dashboard)/playbooks/[playbookId]/page.tsx
  - src/app/(dashboard)/districts/[districtId]/page.tsx
  - src/components/playbooks/product-selector.tsx
  - src/components/playbooks/existing-playbooks-panel.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit individual playbook sections inline"
    - "User can regenerate individual sections without affecting rest of playbook"
    - "User can generate a playbook for a district with selected products from district profile"
    - "User can view existing playbooks for a district before creating new one"
  artifacts:
    - path: "src/components/playbooks/playbook-section.tsx"
      provides: "Section renderer with inline edit mode and regenerate button"
      min_lines: 60
    - path: "src/components/playbooks/generate-playbook-button.tsx"
      provides: "Button + modal for generating playbook from district page"
      min_lines: 50
    - path: "src/components/playbooks/product-selector.tsx"
      provides: "Product selection checklist for generation request"
      min_lines: 40
    - path: "src/components/playbooks/existing-playbooks-panel.tsx"
      provides: "Panel showing existing playbooks for the district"
      min_lines: 30
    - path: "src/app/(dashboard)/districts/[districtId]/page.tsx"
      provides: "District profile page with playbook generation integration"
      contains: "GeneratePlaybookButton|ExistingPlaybooksPanel"
    - path: "src/app/(dashboard)/playbooks/[playbookId]/page.tsx"
      provides: "Playbook detail page with edit/regenerate capabilities"
      contains: "onEdit|onRegenerate"
  key_links:
    - from: "src/components/playbooks/playbook-section.tsx"
      to: "/api/playbooks/[playbookId]/sections/[sectionId]"
      via: "fetch PATCH for edit, fetch POST for regenerate"
      pattern: "fetch.*sections.*sectionId"
    - from: "src/components/playbooks/generate-playbook-button.tsx"
      to: "/api/playbooks"
      via: "fetch POST to generate playbook"
      pattern: "fetch.*api/playbooks.*POST"
    - from: "src/components/playbooks/existing-playbooks-panel.tsx"
      to: "/api/districts/[districtId]/playbooks"
      via: "fetch GET existing playbooks"
      pattern: "fetch.*districts.*playbooks"
---

<objective>
Add inline section editing, section regeneration, playbook generation trigger from district profile, and existing playbooks panel.

Purpose: Completes the playbook editing workflow (PLAY-04, PLAY-05) and the generation trigger from district profiles (PLAY-01, PLAY-07). This plan connects district profiles to playbook generation and enables iterative playbook refinement.

Output: Enhanced PlaybookSection with edit/regenerate, GeneratePlaybookButton with product selector modal, ExistingPlaybooksPanel, and integration into district profile page.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-playbooks/06-01-SUMMARY.md
@.planning/phases/06-playbooks/06-02-SUMMARY.md
@src/services/types/playbook.ts
@src/services/types/product.ts
@src/app/(dashboard)/playbooks/[playbookId]/page.tsx
@src/app/(dashboard)/districts/[districtId]/page.tsx
@src/components/playbooks/playbook-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inline section editing and regeneration</name>
  <files>
    src/components/playbooks/playbook-section.tsx
    src/app/(dashboard)/playbooks/[playbookId]/page.tsx
  </files>
  <action>
Enhance the PlaybookSection component (created in Plan 02) to support inline editing and section regeneration.

**PlaybookSection enhancements:**
- Add state: `isEditing` (boolean), `editContent` (string), `isSaving` (boolean), `isRegenerating` (boolean)
- When NOT editing, show content as before with two action buttons below the section content:
  - "Edit" button (pencil icon) - enters edit mode
  - "Regenerate" button (refresh icon) - only shown when section.retryable is true
- When editing:
  - Replace content display with a `<textarea>` pre-filled with current content. Textarea should auto-resize (min-height 200px, use `rows` based on content line count).
  - Show "Save" (primary) and "Cancel" (outline) buttons
  - "Save" calls `PATCH /api/playbooks/{playbookId}/sections/{sectionId}` with `{ content: editContent }`. On success: update section in parent state, exit edit mode.
  - "Cancel" resets editContent to original and exits edit mode
- Regenerate handler:
  - Call `POST /api/playbooks/{playbookId}/sections/{sectionId}/regenerate`
  - Set section status to 'generating' in local state
  - Start polling `GET /api/playbooks/{playbookId}/sections/{sectionId}` every 2 seconds
  - When status becomes 'complete' or 'error', stop polling and update section content
  - Show spinner while regenerating

**Props update:** Add callback props `onSectionUpdate?: (sectionId: string, updatedSection: PlaybookSection) => void` so parent page can keep its state in sync.

**Playbook detail page updates:**
- Pass onSectionUpdate callback to each PlaybookSection component
- When a section is updated (edit or regenerate complete), update the sections array in local state
- Ensure the section rendering order is maintained: key_themes, product_fit, objections, stakeholders, district_data, fit_assessment
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit --pretty 2>&1 | head -50`</verify>
  <done>PlaybookSection component supports inline editing with save/cancel and section regeneration with polling. Parent detail page receives section updates via callback.</done>
</task>

<task type="auto">
  <name>Task 2: Playbook generation from district profile page</name>
  <files>
    src/components/playbooks/generate-playbook-button.tsx
    src/components/playbooks/product-selector.tsx
    src/components/playbooks/existing-playbooks-panel.tsx
    src/app/(dashboard)/districts/[districtId]/page.tsx
  </files>
  <action>
Create components for generating playbooks from district profile and integrate into the district page.

**ProductSelector component (`src/components/playbooks/product-selector.tsx`):**
- 'use client' component
- Accept props: `{ selectedIds: string[], onSelectionChange: (ids: string[]) => void }`
- On mount, fetch products: `GET /api/products` (gets all tenant products)
- Render as a checklist: each product as a checkbox row with product name + grade range badge + subject area badge
- Clicking toggles selection
- Show "No products available" if empty

**ExistingPlaybooksPanel component (`src/components/playbooks/existing-playbooks-panel.tsx`):**
- 'use client' component
- Accept props: `{ districtId: string }`
- On mount, fetch: `GET /api/districts/{districtId}/playbooks`
- If playbooks exist: render a compact list with districtName (redundant here so skip), productNames, fitCategory badge, generatedAt date, and a Link to `/playbooks/{playbookId}`
- If no playbooks: render nothing (component returns null, keeping the UI clean)
- Header: "Existing Playbooks" with count

**GeneratePlaybookButton component (`src/components/playbooks/generate-playbook-button.tsx`):**
- 'use client' component
- Accept props: `{ districtId: string, districtName: string }`
- Renders a "Generate Playbook" button (primary style)
- On click, opens a modal (same modal pattern from ExcludeModal in Phase 4: fixed overlay, centered card, click outside to close)
- Modal content:
  - Title: "Generate Playbook for {districtName}"
  - ProductSelector component for choosing products
  - Requires at least 1 product selected (disable Generate button otherwise)
  - "Generate" button (primary) + "Cancel" button (outline)
  - On Generate: call `POST /api/playbooks` with `{ districtId, productIds }`. On success (202), redirect to `/playbooks/{playbookId}` using `router.push`.
  - Loading state while generating
  - Error display if API returns error

**District profile page integration:**
- Read the existing `src/app/(dashboard)/districts/[districtId]/page.tsx`
- Add a new section below the fit assessment panel (or in the header area): render GeneratePlaybookButton and ExistingPlaybooksPanel
- These are client components embedded in the server component page. Wrap them in a `<div>` with appropriate spacing.
- The GeneratePlaybookButton and ExistingPlaybooksPanel receive districtId from the page params

**Important:** The district page is currently a server component. The playbook components are client components. This is fine - server components can render client components as children. Pass districtId and districtName as props.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit --pretty 2>&1 | head -50`</verify>
  <done>Generate Playbook button on district profile opens modal with product selector. Existing playbooks panel shows prior playbooks for the district. On generation, user is redirected to new playbook detail page.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no type errors
2. PlaybookSection supports edit mode (textarea + save/cancel) and regenerate (with polling)
3. District profile page has Generate Playbook button and existing playbooks panel
4. Product selector fetches and renders tenant products as checkboxes
5. Generation from district triggers POST /api/playbooks and redirects to detail
6. Existing playbooks for district are displayed with links to detail pages
</verification>

<success_criteria>
- Inline editing: click Edit, modify in textarea, Save persists via API, Cancel reverts
- Section regeneration: click Regenerate, section shows generating state, polls until complete
- Generate Playbook button on district profile: opens modal, select products, generates, redirects
- Existing playbooks panel shows prior playbooks for the current district
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-playbooks/06-03-SUMMARY.md`
</output>
