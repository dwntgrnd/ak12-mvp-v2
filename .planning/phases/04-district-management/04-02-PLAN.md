---
phase: 04-district-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/district/save-button.tsx
  - src/components/district/exclude-button.tsx
  - src/components/district/exclude-modal.tsx
  - src/components/discovery/district-result-card.tsx
  - src/app/(dashboard)/districts/[districtId]/page.tsx
  - src/app/(dashboard)/saved/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can click a save/bookmark button on a district result card in search results"
    - "User can click a save/bookmark button on a district profile page"
    - "User can unsave a district by clicking the button again (toggle behavior)"
    - "User can click exclude on a district card or profile and select a categorized reason from a modal"
    - "User can view all saved districts in the /saved page with district details"
    - "User can view excluded districts in a separate tab on the /saved page"
    - "User can remove a saved district from the saved list"
    - "User can restore an excluded district from the excluded list"
  artifacts:
    - path: "src/components/district/save-button.tsx"
      provides: "Toggle button for saving/unsaving a district"
      exports: ["SaveButton"]
    - path: "src/components/district/exclude-button.tsx"
      provides: "Button that opens exclusion modal"
      exports: ["ExcludeButton"]
    - path: "src/components/district/exclude-modal.tsx"
      provides: "Modal dialog for selecting exclusion category and optional note"
      exports: ["ExcludeModal"]
    - path: "src/app/(dashboard)/saved/page.tsx"
      provides: "Full saved/excluded districts management page with tabs"
  key_links:
    - from: "src/components/district/save-button.tsx"
      to: "/api/districts/[districtId]/save"
      via: "fetch POST to save, fetch DELETE to unsave"
      pattern: "fetch.*api/districts.*save"
    - from: "src/components/district/exclude-modal.tsx"
      to: "/api/districts/[districtId]/exclude"
      via: "fetch POST with { category, note } body"
      pattern: "fetch.*api/districts.*exclude"
    - from: "src/app/(dashboard)/saved/page.tsx"
      to: "/api/districts/saved"
      via: "fetch GET on mount to load saved districts list"
      pattern: "fetch.*api/districts/saved"
    - from: "src/app/(dashboard)/saved/page.tsx"
      to: "/api/districts/[districtId]/restore"
      via: "fetch POST to restore excluded district"
      pattern: "fetch.*api/districts.*restore"
---

<objective>
Build the district management UI — save/exclude buttons, exclusion reason modal, and the saved/excluded districts management page.

Purpose: Users need interactive controls to save districts of interest, exclude irrelevant ones with reasons, and manage both lists from a dedicated page. This transforms the discovery and profile experiences from read-only browsing into active territory building.

Output: 3 new components (SaveButton, ExcludeButton, ExcludeModal), updated district result card and profile page, and fully functional saved districts page with tabs for saved/excluded.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-district-management/04-01-SUMMARY.md

Key codebase references:
@src/components/discovery/district-result-card.tsx (existing card — add save/exclude buttons)
@src/app/(dashboard)/districts/[districtId]/page.tsx (existing profile — add save/exclude buttons)
@src/app/(dashboard)/saved/page.tsx (existing stub — replace with full implementation)
@src/app/(dashboard)/discovery/page.tsx (discovery page pattern for client-side fetch)
@src/services/types/district.ts (SavedDistrict, ExcludedDistrict types)
@src/services/types/controlled-vocabulary.ts (EXCLUSION_CATEGORIES)
@src/components/layout/sidebar.tsx (sidebar nav — /saved route already configured)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create save/exclude action components and wire into discovery cards and profile page</name>
  <files>
    src/components/district/save-button.tsx
    src/components/district/exclude-button.tsx
    src/components/district/exclude-modal.tsx
    src/components/discovery/district-result-card.tsx
    src/app/(dashboard)/districts/[districtId]/page.tsx
  </files>
  <action>
**Create 3 new client components:**

1. **`src/components/district/save-button.tsx`** — SaveButton component
   - Props: `{ districtId: string, initialSaved?: boolean, onStatusChange?: (saved: boolean) => void }`
   - `'use client'` directive
   - Local state: `saved` (boolean), `loading` (boolean)
   - Initialize `saved` from `initialSaved` prop (default false)
   - On click:
     - If not saved: `fetch(\`/api/districts/${districtId}/save\`, { method: 'POST' })` → on success set `saved = true`
     - If saved: `fetch(\`/api/districts/${districtId}/save\`, { method: 'DELETE' })` → on success set `saved = false`
     - Call `onStatusChange?.(newSaved)` after success
   - Render: Use `Bookmark` icon from lucide-react. When saved, fill the icon (use `fill="currentColor"` and `text-primary` class). When not saved, outline only. Add `disabled` state while loading.
   - Stop event propagation on click (`e.preventDefault(); e.stopPropagation()`) so it works inside Link wrappers on cards.
   - Size: compact button suitable for card and page header placement.

2. **`src/components/district/exclude-button.tsx`** — ExcludeButton component
   - Props: `{ districtId: string, onExcluded?: () => void }`
   - `'use client'` directive
   - State: `showModal` (boolean)
   - On click: Set `showModal = true` (with event propagation stop)
   - Render: `Ban` or `XCircle` icon from lucide-react with "Exclude" text. Muted styling.
   - When `showModal` is true, render `<ExcludeModal districtId={districtId} onClose={() => setShowModal(false)} onExcluded={onExcluded} />`

3. **`src/components/district/exclude-modal.tsx`** — ExcludeModal component
   - Props: `{ districtId: string, onClose: () => void, onExcluded?: () => void }`
   - `'use client'` directive
   - State: `category` (string, default ''), `note` (string, default ''), `loading` (boolean), `error` (string | null)
   - Import `EXCLUSION_CATEGORIES` from `@/services/types/controlled-vocabulary` for rendering radio buttons
   - Display user-friendly labels for categories: `already_customer` → "Already a customer", `not_a_fit` → "Not a fit", `budget_timing` → "Budget/timing issue", `other` → "Other"
   - Render as a fixed overlay (modal backdrop with centered white card):
     - Title: "Exclude District"
     - Radio buttons for each exclusion category (from EXCLUSION_CATEGORIES)
     - Textarea for optional note (placeholder: "Add a note (optional)")
     - Show note field always but mark it as "Required" when category is "other"
     - Cancel button (calls `onClose`)
     - Confirm "Exclude" button (disabled until category selected; loading state)
   - On confirm: `fetch(\`/api/districts/${districtId}/exclude\`, { method: 'POST', body: JSON.stringify({ category, note }) })`
     - On success: call `onExcluded?.()` then `onClose()`
     - On 409 (already excluded): show error "This district is already excluded"
     - On other errors: show generic error message

**Modify existing files:**

4. **Update `src/components/discovery/district-result-card.tsx`:**
   - Add `SaveButton` and `ExcludeButton` to each card
   - The card is currently wrapped in a `<Link>`. Restructure: keep the Link for the main card body, but place the action buttons in a separate div that stops propagation.
   - Layout: Card content on left, action buttons stacked vertically on the far right (before the ChevronRight). Or: action buttons in a row below the card details.
   - Recommended layout: Keep existing layout but add a small action bar at bottom-right with SaveButton and ExcludeButton side by side.
   - The buttons must stop propagation so clicking save/exclude does NOT navigate to the profile page.
   - Add optional `isSaved` prop to DistrictResultCard for initial state (default false, will be wired when saved district IDs are available).

5. **Update `src/app/(dashboard)/districts/[districtId]/page.tsx`:**
   - Add `SaveButton` and `ExcludeButton` to the header section (next to the district name/enrollment badge)
   - Since the page is a server component, wrap the buttons in a small client component section, OR simply add them as client components directly (they are 'use client' and can be embedded in server component trees).
   - Place buttons in the header area, right-aligned or after the enrollment badge.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors.
Verify all 3 new component files exist.
Verify `district-result-card.tsx` imports and renders SaveButton.
Verify `districts/[districtId]/page.tsx` imports and renders SaveButton and ExcludeButton.
Verify ExcludeModal imports EXCLUSION_CATEGORIES.
  </verify>
  <done>Save button toggles save state via API. Exclude button opens modal with category selection. Both work on discovery cards (without triggering navigation) and district profile page. Modal validates category selection and submits exclusion reason.</done>
</task>

<task type="auto">
  <name>Task 2: Build saved and excluded districts management page</name>
  <files>
    src/app/(dashboard)/saved/page.tsx
  </files>
  <action>
Replace the stub `src/app/(dashboard)/saved/page.tsx` with a full client component page:

**Page structure:**
- `'use client'` directive
- Title: "Saved Districts" with subtitle "Manage your territory — saved and excluded districts."
- Two tabs: "Saved" (default active) and "Excluded"
- Tab styling: inline tab buttons with active indicator (bottom border or background highlight)

**Saved tab content:**
- On mount (and when tab is "saved"), fetch `GET /api/districts/saved` to get saved districts list
- Display as a list/grid of cards, each showing:
  - District name (linked to `/districts/${districtId}`)
  - Location and enrollment
  - "Saved on" date (formatted from `savedAt`)
  - "Remove" button — calls `DELETE /api/districts/${districtId}/save`, on success removes from list
  - "Exclude" button — opens ExcludeModal, on success removes from saved list (since excluding auto-removes from saved on backend)
- Empty state: "No saved districts yet. Browse the Discovery page to find and save districts." with link to `/discovery`
- Loading state while fetching

**Excluded tab content:**
- On tab switch to "excluded", fetch `GET /api/districts/saved` — WAIT, no. There's no dedicated excluded list endpoint exposed. The existing service has `getExcludedDistricts()` but we need an API route for it.
- Actually, add a query parameter approach: `GET /api/districts/saved?type=excluded` or create a separate route. Looking at Plan 01 — we only created `GET /api/districts/saved` for saved districts.
- **Add to this task:** Create `src/app/api/districts/excluded/route.ts` — `GET` handler that calls `getCurrentUser()` then `getExcludedDistricts(user.id)` and returns `{ items: excludedDistricts }`. Same error handling pattern as the saved route.
- Fetch `GET /api/districts/excluded` on tab switch to "excluded"
- Display as a list/grid of cards, each showing:
  - District name (linked to `/districts/${districtId}`)
  - Exclusion reason category (human-readable label) and note if present
  - "Excluded on" date (formatted from `excludedAt`)
  - "Restore" button — calls `POST /api/districts/${districtId}/restore`, on success removes from list
- Empty state: "No excluded districts."
- Loading state while fetching

**State management:**
- `activeTab: 'saved' | 'excluded'` state
- `savedDistricts: SavedDistrict[]` state
- `excludedDistricts: ExcludedDistrict[]` state
- `loading: boolean` state
- Refetch the active tab's data when switching tabs or after remove/restore/exclude actions

**Additional file:**
- `src/app/api/districts/excluded/route.ts` (the GET endpoint for excluded districts was missed from Plan 01 — add it here)

Import types from `@/services/types/district` for `SavedDistrict` and `ExcludedDistrict`.
Import `ExcludeModal` for the exclude action from saved tab.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile without errors.
Verify `src/app/(dashboard)/saved/page.tsx` is a client component with tab switching.
Verify `src/app/api/districts/excluded/route.ts` exists and exports GET.
Verify the saved tab fetches from `/api/districts/saved`.
Verify the excluded tab fetches from `/api/districts/excluded`.
Verify remove action calls DELETE to save endpoint.
Verify restore action calls POST to restore endpoint.
  </verify>
  <done>Saved districts page displays two tabs. Saved tab shows bookmarked districts with remove and exclude actions. Excluded tab shows excluded districts with category/note and restore action. Both tabs refetch after mutations. Empty states guide users to Discovery page.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — all new and modified code compiles
2. SaveButton component toggles bookmark state and calls save/unsave APIs
3. ExcludeButton opens ExcludeModal with category radio buttons
4. ExcludeModal validates category, shows user-friendly labels, submits to exclude API
5. District result cards have save/exclude buttons that don't interfere with card navigation
6. District profile page has save/exclude buttons in the header
7. Saved page has two tabs (saved/excluded) with loading and empty states
8. Saved tab supports remove and exclude actions per district
9. Excluded tab supports restore action per district
10. All mutations trigger list refetch for immediate UI consistency
</verification>

<success_criteria>
- TypeScript compiles cleanly
- Save button works on both discovery cards and profile page (toggle behavior)
- Exclude flow: button -> modal -> category selection -> confirm -> API call
- Saved districts page lists all saved districts with remove/exclude actions
- Excluded districts tab lists all excluded districts with restore action
- Empty states display when no saved/excluded districts exist
</success_criteria>

<output>
After completion, create `.planning/phases/04-district-management/04-02-SUMMARY.md`
</output>
