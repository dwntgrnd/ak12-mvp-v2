---
phase: 05-solutions-library
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app/(dashboard)/solutions/new/page.tsx
  - src/app/(dashboard)/solutions/[productId]/edit/page.tsx
  - src/components/solutions/product-form.tsx
  - src/app/(dashboard)/solutions/[productId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to a create product form and submit a new product"
    - "Admin can navigate to an edit form for an existing product and save changes"
    - "Admin can soft-delete a product from the product detail page"
    - "Admin can upload product asset metadata from the product detail page"
    - "Non-admin users cannot see create/edit/delete controls"
  artifacts:
    - path: "src/components/solutions/product-form.tsx"
      provides: "Reusable product form for create and edit"
      exports: ["ProductForm"]
    - path: "src/app/(dashboard)/solutions/new/page.tsx"
      provides: "Create new product page"
      contains: "ProductForm"
    - path: "src/app/(dashboard)/solutions/[productId]/edit/page.tsx"
      provides: "Edit existing product page"
      contains: "ProductForm"
    - path: "src/app/(dashboard)/solutions/[productId]/page.tsx"
      provides: "Updated product detail with admin actions (delete, upload)"
      contains: "deleteProduct"
  key_links:
    - from: "src/app/(dashboard)/solutions/new/page.tsx"
      to: "/api/products"
      via: "fetch POST"
      pattern: "POST.*api/products"
    - from: "src/app/(dashboard)/solutions/[productId]/edit/page.tsx"
      to: "/api/products/[productId]"
      via: "fetch PATCH"
      pattern: "PATCH.*api/products"
    - from: "src/app/(dashboard)/solutions/[productId]/page.tsx"
      to: "/api/products/[productId]"
      via: "fetch DELETE for soft-delete"
      pattern: "DELETE.*api/products"
    - from: "src/app/(dashboard)/solutions/[productId]/page.tsx"
      to: "/api/products/[productId]/assets"
      via: "fetch POST for asset upload"
      pattern: "POST.*assets"
---

<objective>
Build admin product management UI: create, edit, delete products, and upload asset metadata.

Purpose: Publisher admins can manage the product catalog through create/edit forms, soft-delete functionality, and asset metadata registration. Non-admin users see read-only views.

Output: Reusable product form component, create/edit pages, and admin action buttons on the product detail page.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-solutions-library/05-01-SUMMARY.md
@.planning/phases/05-solutions-library/05-02-SUMMARY.md
@src/services/types/product.ts
@src/services/types/controlled-vocabulary.ts
@src/app/(dashboard)/solutions/[productId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable product form and create/edit pages</name>
  <files>
    src/components/solutions/product-form.tsx
    src/app/(dashboard)/solutions/new/page.tsx
    src/app/(dashboard)/solutions/[productId]/edit/page.tsx
  </files>
  <action>
**Create `src/components/solutions/product-form.tsx`:**

'use client' component. Reusable form for both create and edit modes.

Props:
```typescript
interface ProductFormProps {
  mode: 'create' | 'edit';
  initialData?: {
    name: string;
    description: string;
    gradeRange: string;
    subjectArea: string;
    keyFeatures: string[];
    targetChallenges: string[];
    competitiveDifferentiators: string[];
    approvedMessaging: string[];
  };
  productId?: string; // required for edit mode
  onSuccess?: (product: Product) => void;
}
```

Form fields:
- Name: text input, required
- Description: textarea, required, 4 rows
- Grade Range: select dropdown populated from GRADE_RANGES, required
- Subject Area: select dropdown populated from SUBJECT_AREAS, required
- Key Features: dynamic string array input. Show existing items as removable chips/tags. Add button + text input to append new item. Start empty for create, pre-filled for edit.
- Target Challenges: same dynamic string array pattern
- Competitive Differentiators: same dynamic string array pattern
- Approved Messaging: same dynamic string array pattern

For string array inputs, create a reusable inline pattern:
- Show items as a list with X button to remove each
- Below the list, a flex row with text input + "Add" button
- State: temporary input value for each array field

Form behavior:
- Create mode: POST to /api/products, on success redirect to /solutions/[newProductId] using router.push
- Edit mode: PATCH to /api/products/[productId], on success redirect to /solutions/[productId]
- Submit button: "Create Product" or "Save Changes" based on mode
- Cancel button: navigates back to /solutions (create) or /solutions/[productId] (edit)
- Loading state: disable submit button, show "Saving..." text
- Error state: show error message above form in red text
- All inputs styled with standard Tailwind form classes: w-full rounded-md border border-input bg-background px-3 py-2 text-sm

**Create `src/app/(dashboard)/solutions/new/page.tsx`:**

'use client' page. Admin-only create product page.

- Fetch current user role via GET to a lightweight endpoint or use client-side check. For simplicity: attempt to render the form, and the POST endpoint will enforce admin. But for UX, add a simple client-side guard: fetch GET /api/products (which requires auth) and if 403, show "Access denied" message. Actually, simpler approach: just render the form. If submission fails with 403, the form's error handling will display it. This is acceptable for MVP.
- Page header: "Create New Product" h1, "Add a new product to your catalog." description
- Render ProductForm with mode="create"
- Back link to /solutions

**Create `src/app/(dashboard)/solutions/[productId]/edit/page.tsx`:**

'use client' page. Admin-only edit product page.

- On mount, fetch product data via GET /api/products/[productId]
- Loading state while fetching
- Error state if product not found (404)
- Page header: "Edit Product" h1, product name as subtitle
- Render ProductForm with mode="edit", initialData from fetched product, productId from params
- Back link to /solutions/[productId]
- Extract productId from URL using useParams() hook from next/navigation
  </action>
  <verify>Run `npx tsc --noEmit` and confirm zero TypeScript errors. Verify all 3 files exist.</verify>
  <done>ProductForm component handles both create and edit modes with all product fields including dynamic string array inputs. Create page at /solutions/new renders the form in create mode. Edit page at /solutions/[productId]/edit fetches existing data and renders the form in edit mode. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add admin actions to product detail page (delete, asset upload, edit/create links)</name>
  <files>src/app/(dashboard)/solutions/[productId]/page.tsx</files>
  <action>
Update the product detail page (created in Plan 02) to include admin-only action buttons.

**Challenge:** The detail page is a server component, but delete/upload actions need client interactivity. Solution: Create a client component wrapper for the admin actions section and embed it in the server page.

**Add an inline client component or create `src/components/solutions/admin-actions.tsx`** (prefer inline 'use client' component file for simplicity, but creating a separate component is cleaner):

Create `src/components/solutions/admin-actions.tsx` as a 'use client' component:

Props: `{ productId: string; productName: string; isAdmin: boolean }`

If not isAdmin, render nothing (return null).

Render admin actions panel with:

1. **Action buttons row** (flex gap-3, right-aligned):
   - "Edit Product" button: Link to /solutions/[productId]/edit, styled as primary button (bg-primary text-primary-foreground px-4 py-2 rounded-md text-sm font-medium hover:bg-primary/90)
   - "Delete Product" button: styled as destructive (bg-destructive text-destructive-foreground px-4 py-2 rounded-md text-sm font-medium hover:bg-destructive/90). On click, show confirmation dialog (window.confirm with "Are you sure you want to delete {productName}? This action can be undone by an admin."). If confirmed, send DELETE to /api/products/[productId]. On success, redirect to /solutions via router.push. On error, show error alert.

2. **Asset upload section** (border-t pt-4 mt-4):
   - Heading: "Upload Asset" (text-sm font-semibold)
   - Form with fields: fileName (text input, required), fileType (text input, placeholder "application/pdf", required), fileSize (number input, in bytes, required), url (text input, placeholder "https://...", required)
   - Submit button: "Add Asset"
   - On submit: POST to /api/products/[productId]/assets with JSON body
   - On success: show success message, clear form, call optional onAssetAdded callback
   - On error: show error message in red
   - Note: This is MVP asset metadata registration. Actual file upload to cloud storage is deferred.

**Update the server page** `src/app/(dashboard)/solutions/[productId]/page.tsx`:

- Import AdminActions component
- After getCurrentUser, determine isAdmin: `user.role === 'publisher-admin' || user.role === 'super-admin'`
- Place AdminActions in the header area, below the description, passing productId, productName, and isAdmin
- On the solutions catalog page (Plan 02), add a conditional "Add Product" button/link visible only to admins. Since the solutions page is a client component, add a simple admin check: fetch a lightweight endpoint or add isAdmin to the products API response. Simpler approach for MVP: add a "New Product" link that will show the create form page -- the create endpoint enforces admin. Show the link always (minor UX issue acceptable for MVP, as the submit will fail with 403 for non-admins). Better approach: add an `isAdmin` state by calling getCurrentUser on mount. Actually simplest: just add the link, non-admin submissions fail gracefully.

Add to `src/app/(dashboard)/solutions/page.tsx`:
- Add a "New Product" link button in the page header, right-aligned: `<Link href="/solutions/new">` styled as primary button
- This will be visible to all users but only admins can actually submit (enforced by API)
  </action>
  <verify>Run `npx tsc --noEmit` and confirm zero TypeScript errors. Verify AdminActions component file exists. Verify updated detail page imports and renders AdminActions. Verify solutions page has "New Product" link.</verify>
  <done>Product detail page shows admin action buttons (edit link, delete with confirmation, asset upload form) when user is admin. Non-admin users see the read-only product detail without admin controls. Solutions catalog page has "New Product" link in header. Delete uses soft-delete via API. Asset upload submits metadata via POST. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- ProductForm component exists with create and edit modes
- Create page exists at /solutions/new
- Edit page exists at /solutions/[productId]/edit
- AdminActions component shows edit/delete/upload controls
- Product detail page conditionally renders admin actions based on user role
- Solutions catalog page has "New Product" link
- Delete button confirms before sending DELETE request
- Asset upload form submits metadata to POST /api/products/[productId]/assets
</verification>

<success_criteria>
Admins can create new products via form, edit existing products via pre-filled form, soft-delete products with confirmation, and register product asset metadata. Non-admin users see read-only views without admin controls.
</success_criteria>

<output>
After completion, create `.planning/phases/05-solutions-library/05-03-SUMMARY.md`
</output>
