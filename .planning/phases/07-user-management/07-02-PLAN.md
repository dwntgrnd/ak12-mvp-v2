---
phase: 07-user-management
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/app/(dashboard)/admin/page.tsx
  - src/components/admin/users-list.tsx
  - src/components/admin/invite-user-form.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can see a list of all tenant users with email, role, and status"
    - "Admin can invite a new user by entering email, name, and selecting a role"
    - "Admin can deactivate an active user via action button on the users list"
    - "Admin can reactivate a deactivated user via action button on the users list"
    - "Sidebar admin nav only shows for publisher-admin and super-admin roles"
  artifacts:
    - path: "src/app/(dashboard)/admin/page.tsx"
      provides: "Admin page with users management UI"
      min_lines: 20
    - path: "src/components/admin/users-list.tsx"
      provides: "Users list with status badges and action buttons"
      min_lines: 50
    - path: "src/components/admin/invite-user-form.tsx"
      provides: "Invite user form with email, name, role fields"
      min_lines: 40
    - path: "src/components/layout/sidebar.tsx"
      provides: "Role-based admin nav gating"
      contains: "role"
  key_links:
    - from: "src/components/admin/users-list.tsx"
      to: "/api/users"
      via: "fetch call for user list"
      pattern: "fetch.*api/users"
    - from: "src/components/admin/invite-user-form.tsx"
      to: "/api/users/invite"
      via: "fetch POST for invite"
      pattern: "fetch.*api/users/invite"
    - from: "src/components/admin/users-list.tsx"
      to: "/api/users/[userId]/deactivate"
      via: "fetch PATCH for deactivate"
      pattern: "fetch.*deactivate"
    - from: "src/components/layout/sidebar.tsx"
      to: "/api/users/me"
      via: "fetch or server-side role check"
      pattern: "role.*admin|publisher-admin"
---

<objective>
Admin user management UI and sidebar role-based gating.

Purpose: Complete the user management feature by building the admin interface for inviting, viewing, deactivating, and reactivating users. Also fulfill the Phase 2 TODO to gate the admin nav by role.
Output: Functional admin page with users list, invite form, and lifecycle actions. Sidebar conditionally shows admin nav based on user role.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/07-user-management/07-01-SUMMARY.md

@src/services/types/user.ts
@src/services/types/common.ts
@src/app/(dashboard)/admin/page.tsx
@src/components/layout/sidebar.tsx
@src/components/solutions/admin-actions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build admin users management page with list and invite form</name>
  <files>
    src/app/(dashboard)/admin/page.tsx
    src/components/admin/users-list.tsx
    src/components/admin/invite-user-form.tsx
  </files>
  <action>
Replace the stub admin page with a full user management interface. Create two client components and wire them into the admin page.

**src/components/admin/users-list.tsx** ('use client'):
- Props: none (fetches its own data)
- State: users array (TenantUser[]), loading boolean, error string
- On mount (useEffect), fetch GET /api/users, parse response.users into state
- Render a table (or styled list) with columns: Name, Email, Role, Status, Actions
- Status badges with color coding:
  - 'active' -> green badge (bg-green-100 text-green-800)
  - 'pending' -> yellow badge (bg-yellow-100 text-yellow-800)
  - 'deactivated' -> red badge (bg-red-100 text-red-800)
- Role display: 'publisher-admin' -> "Admin", 'publisher-rep' -> "Rep"
- Action buttons per row:
  - If status is 'active': show "Deactivate" button (text-red-600 hover:text-red-800)
  - If status is 'deactivated': show "Reactivate" button (text-green-600 hover:text-green-800)
  - If status is 'pending': no action buttons (pending users can't be managed yet)
- Deactivate action: window.confirm("Deactivate {name}? They will lose access."), then PATCH /api/users/{userId}/deactivate, update local state on success
- Reactivate action: PATCH /api/users/{userId}/reactivate, update local state on success
- Expose a refreshUsers function and accept an optional onUserInvited callback OR use a key-based refresh pattern
- Handle empty state: "No users found" message
- Handle error state: display error message
- Export a way to trigger refresh (either via ref, callback prop, or key prop)

**src/components/admin/invite-user-form.tsx** ('use client'):
- Props: onSuccess callback (called after successful invite to refresh list)
- State: email string, displayName string, role string (default 'publisher-rep'), isSubmitting boolean, error string
- Form with 3 fields:
  - Email input (type="email", required)
  - Display Name input (type="text", required)
  - Role select dropdown with options: "Sales Rep" (value: publisher-rep), "Admin" (value: publisher-admin)
- Submit handler: POST /api/users/invite with { email, displayName, role }
  - On success (201): clear form, call onSuccess()
  - On 409 (duplicate): show "A user with this email already exists"
  - On other errors: show error message
- Submit button: "Send Invite" with loading state (disabled + "Inviting...")
- Styled as a card/panel with a heading "Invite User"
- Use existing Tailwind patterns: rounded-lg border p-4, input styling consistent with other forms in the app

**src/app/(dashboard)/admin/page.tsx**:
- Replace stub with full admin page
- Layout: heading "User Management" at top, then two-column layout on lg (invite form left/top, users list right/bottom) or single column stacked layout
- Import and render InviteUserForm and UsersList
- Use a key-based refresh: maintain a refreshKey state, pass to UsersList as key prop, InviteUserForm onSuccess increments refreshKey
- Page is a client component ('use client') to manage the refresh state

Follow the established UI patterns:
- Page padding: p-6
- Heading: text-2xl font-semibold font-heading
- Subheading: text-muted-foreground mt-2
- Cards: rounded-lg border bg-card p-4 (or p-6)
- Buttons: consistent with other admin actions in the app
  </action>
  <verify>Run `npx tsc --noEmit` and confirm zero TypeScript errors. Verify all 3 files exist (admin page, users-list, invite-user-form).</verify>
  <done>Admin page at /admin shows users list with email/role/status, invite form creates new pending users, deactivate/reactivate buttons update user status with optimistic UI feedback. All 3 component files compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Gate sidebar admin nav by user role from database</name>
  <files>src/components/layout/sidebar.tsx</files>
  <action>
Update the sidebar to gate admin nav visibility based on the user's role from the local database, replacing the `const showAdminNav = true` placeholder.

The challenge: Sidebar is a client component using Clerk's useUser() hook. User role lives in the local DB (not Clerk). Options to resolve:

**Approach: Add a lightweight /api/users/me endpoint and fetch role client-side.**

1. Create a small API route at src/app/api/users/me/route.ts:
   - Call getCurrentUser() from auth-utils
   - Return { role: user.role } with status 200
   - On auth error, return { role: null } with 200 (don't break sidebar)

2. In sidebar.tsx:
   - Add state: `const [userRole, setUserRole] = useState<string | null>(null)`
   - Add useEffect that fetches GET /api/users/me and sets userRole from response
   - Replace `const showAdminNav = true` with `const showAdminNav = userRole === 'publisher-admin' || userRole === 'super-admin'`
   - Admin nav section already conditionally renders based on showAdminNav, so no other changes needed
   - While role is loading (null), hide admin nav (safe default -- it appears once role loads)

This adds ONE extra file (src/app/api/users/me/route.ts) beyond what's listed in files_modified -- acceptable since it's a tiny supporting endpoint.

Remove the TODO comment: `// TODO: Gate admin nav based on user role from local DB (Phase 7)`
  </action>
  <verify>Run `npx tsc --noEmit` and confirm zero errors. Verify sidebar.tsx no longer contains `showAdminNav = true`. Verify /api/users/me route exists.</verify>
  <done>Sidebar admin nav only shows for publisher-admin and super-admin users. The `showAdminNav = true` placeholder and Phase 7 TODO are removed. Non-admin users see only the main navigation items.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0
2. /admin page renders UsersList and InviteUserForm components
3. UsersList fetches from GET /api/users and displays user data
4. InviteUserForm POSTs to /api/users/invite and refreshes list on success
5. Deactivate/reactivate buttons call correct API endpoints
6. Sidebar admin nav gated by role (not hardcoded true)
7. Non-admin users cannot see admin nav item
</verification>

<success_criteria>
- Admin page shows full user management UI (list + invite form)
- Users list displays email, name, role (Admin/Rep), and status (active/pending/deactivated) with color-coded badges
- Invite form creates user with 'pending' status and refreshes list
- Deactivate button on active users, Reactivate button on deactivated users
- Sidebar admin nav conditionally rendered based on database role
- Phase 2 TODO (showAdminNav gating) resolved
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-user-management/07-02-SUMMARY.md`
</output>
