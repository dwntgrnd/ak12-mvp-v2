---
phase: 02-auth-data-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/layout.tsx
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
  - src/app/(dashboard)/layout.tsx
  - src/middleware.ts
  - src/components/layout/sidebar.tsx
  - .env
  - .env.example
autonomous: false
user_setup:
  - service: clerk
    why: "Authentication provider for user sign-in and session management"
    env_vars:
      - name: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard (clerk.com) -> Your Application -> API Keys"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard (clerk.com) -> Your Application -> API Keys"
    dashboard_config:
      - task: "Create a Clerk application"
        location: "clerk.com -> Create Application -> Select 'Email' sign-in method"
      - task: "Enable email+password authentication"
        location: "Clerk Dashboard -> User & Authentication -> Email, Phone, Username -> Enable Email"

must_haves:
  truths:
    - "User can sign in with email and password via Clerk"
    - "User session persists across browser refresh"
    - "Unauthenticated users are redirected to sign-in page"
    - "Authenticated users see their identity in the sidebar"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route protection via Clerk middleware"
      contains: "clerkMiddleware"
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Clerk sign-in page"
      contains: "SignIn"
    - path: "src/app/layout.tsx"
      provides: "ClerkProvider wrapping entire app"
      contains: "ClerkProvider"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Real user identity from Clerk session"
      contains: "useUser"
  key_links:
    - from: "src/middleware.ts"
      to: "@clerk/nextjs/server"
      via: "clerkMiddleware import"
      pattern: "clerkMiddleware"
    - from: "src/app/layout.tsx"
      to: "@clerk/nextjs"
      via: "ClerkProvider wrapper"
      pattern: "ClerkProvider"
    - from: "src/components/layout/sidebar.tsx"
      to: "@clerk/nextjs"
      via: "useUser hook for real identity"
      pattern: "useUser"
---

<objective>
Integrate Clerk authentication so users can sign in with email and password, sessions persist across refresh, and dashboard routes are protected behind authentication.

Purpose: Fulfills AUTH-01 (sign in) and AUTH-02 (session persistence). Replaces the mock user in the sidebar with real Clerk session data. Establishes the authentication foundation all protected features depend on.
Output: Working Clerk auth flow with sign-in page, middleware protection, and real user identity in sidebar.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/layout.tsx
@src/app/(auth)/login/page.tsx
@src/app/(auth)/layout.tsx
@src/app/(dashboard)/layout.tsx
@src/components/layout/sidebar.tsx
@src/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Clerk and configure authentication</name>
  <files>
    src/middleware.ts
    src/app/layout.tsx
    src/app/(auth)/login/page.tsx
    src/app/(auth)/sign-up/[[...sign-up]]/page.tsx
    .env
    .env.example
    package.json
  </files>
  <action>
Install Clerk Next.js SDK:
```bash
npm install @clerk/nextjs
```

**1. Update .env** (append to existing, preserving DATABASE_URL if present):
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_PLACEHOLDER
CLERK_SECRET_KEY=sk_test_PLACEHOLDER
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/login
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/discovery
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/discovery
```

**2. Update .env.example** (append to existing):
```
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_YOUR_KEY
CLERK_SECRET_KEY=sk_test_YOUR_KEY
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/login
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/discovery
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/discovery
```

**3. Create src/middleware.ts** (root of src, not app):
```typescript
import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';

const isPublicRoute = createRouteMatcher([
  '/login(.*)',
  '/sign-up(.*)',
  '/api/health',
]);

export default clerkMiddleware(async (auth, request) => {
  if (!isPublicRoute(request)) {
    await auth.protect();
  }
});

export const config = {
  matcher: [
    // Skip Next.js internals and static files
    '/((?!_next|[^?]*\\.(?:html?|css|js(?!on)|jpe?g|webp|png|gif|svg|ttf|woff2?|ico|csv|docx?|xlsx?|zip|webmanifest)).*)',
    // Always run for API routes
    '/(api|trpc)(.*)',
  ],
};
```

Key decisions:
- `/api/health` is public (monitoring should work without auth)
- `/login` and `/sign-up` are public (can't require auth to sign in)
- All other routes (dashboard, API) require authentication via `auth.protect()`
- The matcher pattern skips static assets for performance

**4. Update src/app/layout.tsx:**
Wrap the entire app in `<ClerkProvider>`. Import from `@clerk/nextjs`. Keep existing font loading and metadata unchanged.

```typescript
import { ClerkProvider } from '@clerk/nextjs';
```

Wrap `{children}` inside `<body>` with `<ClerkProvider>`:
```tsx
<body className={`${manrope.variable} ${inter.variable} antialiased`}>
  <ClerkProvider>
    {children}
  </ClerkProvider>
</body>
```

**5. Replace src/app/(auth)/login/page.tsx:**
Replace the placeholder with Clerk's `<SignIn />` component:

```tsx
import { SignIn } from '@clerk/nextjs';

export default function LoginPage() {
  return <SignIn />;
}
```

This renders Clerk's pre-built sign-in form with email+password support. The form styling is handled by Clerk's theme system. It respects the NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL env var for redirect after successful login.

**6. Create src/app/(auth)/sign-up/[[...sign-up]]/page.tsx:**
Clerk needs a catch-all route for sign-up flows:

```tsx
import { SignUp } from '@clerk/nextjs';

export default function SignUpPage() {
  return <SignUp />;
}
```

The `[[...sign-up]]` catch-all pattern is required by Clerk for multi-step sign-up flows (email verification, etc.).
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with Clerk imports.
Verify src/middleware.ts exists with clerkMiddleware.
Verify src/app/layout.tsx contains ClerkProvider.
Verify src/app/(auth)/login/page.tsx contains SignIn component.
Verify src/app/(auth)/sign-up/[[...sign-up]]/page.tsx exists.
  </verify>
  <done>
Clerk SDK installed. Middleware protects all dashboard routes. ClerkProvider wraps the app. Sign-in page renders Clerk's SignIn component. Sign-up catch-all route exists. Environment variables documented in .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace mock user in sidebar with Clerk session data</name>
  <files>
    src/components/layout/sidebar.tsx
    src/app/(dashboard)/layout.tsx
  </files>
  <action>
**1. Update src/components/layout/sidebar.tsx:**

Remove the hardcoded `mockUser` object entirely. Replace with Clerk's `useUser` hook to get real user identity:

```typescript
import { useUser, UserButton } from '@clerk/nextjs';
```

Replace the mock user section at the bottom of the sidebar:
- Use `const { user, isLoaded } = useUser()` to get the current user
- Display `user?.fullName ?? user?.primaryEmailAddress?.emailAddress ?? 'Loading...'` for the name
- For organizationName, display "AlchemyK12" as a static placeholder for now (organization/tenant mapping comes when Prisma User table is populated in later phases)
- For role badge, show "publisher-admin" as static placeholder (role comes from local DB, not Clerk)
- Add Clerk's `<UserButton />` component for account management (sign out, profile)
- Show a loading skeleton (simple "..." text) while `isLoaded` is false

Replace the user context section at the bottom:
```tsx
{/* User Context */}
<div className="px-4 py-4 border-t border-white/10">
  {isLoaded && user ? (
    <div className="flex items-center gap-3">
      <UserButton
        appearance={{
          elements: { avatarBox: 'w-8 h-8' }
        }}
      />
      <div className="flex-1 min-w-0">
        <p className="text-sm font-medium text-sidebar-foreground truncate">
          {user.fullName ?? user.primaryEmailAddress?.emailAddress}
        </p>
        <p className="text-xs text-sidebar-foreground/60 truncate">
          AlchemyK12
        </p>
      </div>
    </div>
  ) : (
    <div className="space-y-1">
      <div className="h-4 w-24 bg-sidebar-hover rounded animate-pulse" />
      <div className="h-3 w-16 bg-sidebar-hover rounded animate-pulse" />
    </div>
  )}
</div>
```

Keep the admin nav visibility check but change it to always show admin for now (we cannot check role from Clerk alone -- role is in local DB). Use a comment explaining this will be gated properly once User table is populated:
```typescript
// TODO: Gate admin nav based on user role from local DB (Phase 7)
const showAdminNav = true;
```

**2. Update src/app/(dashboard)/layout.tsx** (if needed):
No changes expected unless TypeScript errors arise from the sidebar changes. The dashboard layout already imports and renders `<Sidebar />`.
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with Clerk hooks in sidebar.
Verify src/components/layout/sidebar.tsx contains `useUser` import.
Verify src/components/layout/sidebar.tsx contains `UserButton` import.
Verify the hardcoded `mockUser` object is removed.
  </verify>
  <done>
Sidebar displays real Clerk user identity (name, email). UserButton provides sign-out and account management. Mock user data completely removed. Admin nav temporarily visible to all users with TODO comment for role-based gating.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Clerk authentication flow</name>
  <files>none (verification only)</files>
  <action>
Human verification of the complete Clerk authentication integration. This requires:
- Valid Clerk API keys configured in .env
- Node.js >= 20.9.0 for the Next.js dev server
- A test user created in the Clerk dashboard

Verification steps:
1. Ensure .env has valid Clerk keys (NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY from Clerk dashboard)
2. Ensure Node.js >= 20.9.0 is available (required for Next.js dev server)
3. Run `npm run dev` and navigate to http://localhost:3000
4. You should be redirected to /login (unauthenticated)
5. Sign in with email and password (create a test user in Clerk dashboard if needed)
6. After sign-in, you should be redirected to /discovery
7. The sidebar should show your real name (not "Sarah Chen")
8. The UserButton (avatar) should appear in the sidebar bottom
9. Click UserButton -> "Sign out" -> should redirect to /login
10. Refresh the page while signed in -> session should persist (not redirected to login)
11. Visit http://localhost:3000/api/health -> should return JSON without requiring auth
  </action>
  <verify>All 11 verification steps pass successfully.</verify>
  <done>Auth flow works end-to-end: sign-in, session persistence, route protection, sign-out, and public health check endpoint.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0 with Clerk imports
2. Middleware protects dashboard routes, allows public routes
3. Sign-in page renders Clerk's SignIn component (not placeholder)
4. Root layout wraps app in ClerkProvider
5. Sidebar shows real user identity from Clerk session
6. UserButton provides sign-out capability
</verification>

<success_criteria>
- AUTH-01: User can sign in with email and password via Clerk
- AUTH-02: User session persists across browser refresh (Clerk handles via cookies)
- Unauthenticated users redirected to /login
- /api/health remains publicly accessible
- Mock user data fully removed from sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-data-layer/02-02-SUMMARY.md`
</output>
