---
phase: 02-auth-data-layer
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - prisma/seed.ts
  - src/app/api/health/route.ts
  - package.json
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Database contains seeded California district data with demographics, proficiency, and funding"
    - "Health check endpoint reports database connectivity status"
    - "Seed script is repeatable without duplicating data"
  artifacts:
    - path: "prisma/seed.ts"
      provides: "California district seed data"
      contains: "prisma.district"
    - path: "src/app/api/health/route.ts"
      provides: "Health check with database connectivity"
      contains: "prisma"
  key_links:
    - from: "prisma/seed.ts"
      to: "src/lib/prisma.ts"
      via: "PrismaClient import for seeding"
      pattern: "PrismaClient|prisma"
    - from: "src/app/api/health/route.ts"
      to: "src/lib/prisma.ts"
      via: "prisma import for DB check"
      pattern: "prisma.*\\$queryRaw|prisma.*\\$executeRaw|prisma.*findFirst"
---

<objective>
Seed the database with realistic California school district data and upgrade the health check endpoint to report database connectivity.

Purpose: Fulfills the remaining Phase 2 success criteria -- seeded district data for Phase 3's search/discovery features, and health check with DB status for AUTH-03. Without seed data, Phase 3 has nothing to search over.
Output: Seed script with 20+ California districts, health check returning DB status.
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-data-layer/02-01-SUMMARY.md
@prisma/schema.prisma
@src/lib/prisma.ts
@src/app/api/health/route.ts
@src/services/types/district.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create California district seed script</name>
  <files>
    prisma/seed.ts
    package.json
    tsconfig.json
  </files>
  <action>
Create prisma/seed.ts with realistic California school district data. Use PrismaClient directly (not the singleton -- seed scripts run standalone via `npx prisma db seed`).

**Seed data requirements:**
- At minimum 20 California school districts with varied characteristics
- Each district must have: name, location (city), county, enrollment, demographics (JSON), proficiency (JSON), funding (JSON)
- Data should be realistic but can be approximate (this is seed data, not production data)
- Include a mix of district sizes (small rural, medium suburban, large urban)

**District data structure per prisma schema:**
```typescript
{
  name: "Los Angeles Unified School District",
  location: "Los Angeles, CA",
  county: "Los Angeles",
  enrollment: 422276,
  demographics: {
    "Hispanic/Latino": 73.4,
    "White": 10.3,
    "African American": 7.7,
    "Asian": 3.9,
    "Filipino": 2.1,
    "Two or More Races": 1.8,
    "Other": 0.8
  },
  proficiency: {
    "Math": 33.2,
    "ELA": 40.1,
    "Science": 25.8
  },
  funding: {
    "Per Pupil Spending": 16890,
    "Total Budget": 7130000000,
    "Title I": 458000000,
    "LCFF Supplemental": 1200000000
  }
}
```

Include these real California districts (with approximate but realistic data):
1. Los Angeles Unified (LA County, ~422K enrollment)
2. San Diego Unified (San Diego County, ~98K)
3. Long Beach Unified (LA County, ~70K)
4. Fresno Unified (Fresno County, ~72K)
5. Santa Ana Unified (Orange County, ~44K)
6. San Francisco Unified (SF County, ~49K)
7. Sacramento City Unified (Sacramento County, ~40K)
8. Oakland Unified (Alameda County, ~34K)
9. San Bernardino City Unified (San Bernardino County, ~47K)
10. Stockton Unified (San Joaquin County, ~37K)
11. Elk Grove Unified (Sacramento County, ~63K)
12. San Jose Unified (Santa Clara County, ~30K)
13. Riverside Unified (Riverside County, ~41K)
14. Garden Grove Unified (Orange County, ~41K)
15. Capistrano Unified (Orange County, ~47K)
16. Corona-Norco Unified (Riverside County, ~51K)
17. Clovis Unified (Fresno County, ~43K)
18. Poway Unified (San Diego County, ~36K)
19. Irvine Unified (Orange County, ~37K)
20. Vista Unified (San Diego County, ~22K)
21. Bakersfield City (Kern County, ~30K)
22. Compton Unified (LA County, ~19K)
23. Lodi Unified (San Joaquin County, ~28K)
24. Manteca Unified (San Joaquin County, ~25K)
25. Modesto City Schools (Stanislaus County, ~29K)

For each district, generate realistic:
- **Demographics:** Hispanic/Latino, White, African American, Asian percentages (should sum to ~100%)
- **Proficiency:** Math and ELA proficiency rates as percentages (varies by district)
- **Funding:** Per Pupil Spending (range $10K-$20K), Total Budget (derived from enrollment x per-pupil)

**Make the seed idempotent** using `upsert` with a unique identifier (name + county):
```typescript
await prisma.district.upsert({
  where: { name_county: { name: district.name, county: district.county } },
  update: { ...district },
  create: { ...district },
});
```

Note: The unique constraint name depends on how Prisma names the compound unique -- check the generated schema. If the compound unique on [name, county] is defined with `@@unique([name, county])`, Prisma auto-generates a `name_county` compound key for the where clause.

**Also seed a default tenant and admin user** for development:
```typescript
const tenant = await prisma.tenant.upsert({
  where: { organizationName: 'EduVision Publishing' },
  update: {},
  create: {
    organizationName: 'EduVision Publishing',
    status: 'active',
  },
});

await prisma.user.upsert({
  where: { email: 'admin@eduvision.com' },
  update: {},
  create: {
    clerkId: 'dev_placeholder',
    tenantId: tenant.id,
    email: 'admin@eduvision.com',
    displayName: 'Sarah Chen',
    role: 'publisher-admin',
    status: 'active',
    invitedAt: new Date(),
  },
});
```

Add the seed command to package.json:
```json
"prisma": {
  "seed": "npx tsx prisma/seed.ts"
}
```

Install tsx as a dev dependency for running TypeScript seed scripts:
```bash
npm install -D tsx
```

Also ensure tsconfig.json has appropriate settings for the seed script. If the existing tsconfig excludes node_modules but doesn't cover prisma/, add the prisma directory or rely on tsx's own TypeScript handling (tsx doesn't use tsconfig for execution, only for type checking).
  </action>
  <verify>
If DATABASE_URL is configured and database is accessible:
- Run `npx prisma db seed` -- should complete without errors
- Run `npx prisma studio` (or a quick script) to verify districts are seeded
- Re-run `npx prisma db seed` to verify idempotency (no duplicates)

If DATABASE_URL is not configured:
- Run `npx tsc --noEmit` (may need to skip seed.ts if it's outside src/)
- Verify prisma/seed.ts exists and contains district data
- Verify package.json has prisma.seed configuration
  </verify>
  <done>
prisma/seed.ts contains 25 California districts with demographics, proficiency, and funding JSONB data. Default tenant (EduVision Publishing) and admin user are seeded. Seed script is idempotent via upserts. package.json configured with prisma.seed command.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade health check endpoint with database connectivity</name>
  <files>
    src/app/api/health/route.ts
  </files>
  <action>
Update src/app/api/health/route.ts to check database connectivity. The current endpoint returns a static `{ status: 'ok', timestamp, version }` response.

Upgrade to:
1. Import the prisma singleton from `@/lib/prisma`
2. Attempt a lightweight DB query: `prisma.$queryRaw<[{now: Date}]>(Prisma.sql\`SELECT NOW()\`)`
3. Return comprehensive health status

New implementation:

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';
import { Prisma } from '@prisma/client';

export async function GET() {
  const timestamp = new Date().toISOString();
  let dbStatus: 'ok' | 'down' = 'down';
  let dbLatencyMs: number | null = null;

  try {
    const start = Date.now();
    await prisma.$queryRaw(Prisma.sql`SELECT 1`);
    dbLatencyMs = Date.now() - start;
    dbStatus = 'ok';
  } catch {
    dbStatus = 'down';
  }

  const overallStatus = dbStatus === 'ok' ? 'ok' : 'degraded';

  return NextResponse.json(
    {
      status: overallStatus,
      timestamp,
      version: '0.2.0',
      checks: {
        database: {
          status: dbStatus,
          latencyMs: dbLatencyMs,
        },
      },
    },
    { status: overallStatus === 'ok' ? 200 : 503 }
  );
}
```

Key decisions:
- Use `SELECT 1` for minimal overhead health check (not querying actual tables)
- Return 503 if DB is down (standard for unhealthy service)
- Include latency measurement for monitoring
- Bump version to 0.2.0 to reflect Phase 2 additions
- Return 'degraded' (not 'down') when DB is unavailable -- the API itself is responding, just DB is unreachable
- The `Prisma.sql` tagged template provides SQL injection safety (though not needed for `SELECT 1`, it's good practice)
  </action>
  <verify>
Run `npx tsc --noEmit` -- TypeScript compiles with prisma import in health route.
Verify src/app/api/health/route.ts imports from '@/lib/prisma'.
Verify response includes `checks.database.status` field.
If dev server can run: `curl http://localhost:3000/api/health` returns JSON with database status.
  </verify>
  <done>
Health check endpoint reports database connectivity with status and latency. Returns 200 when DB is connected, 503 when degraded. Fulfills AUTH-03 requirement and Phase 2 success criterion #5.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0
2. prisma/seed.ts contains 25+ California districts
3. Seed data includes demographics, proficiency, and funding JSONB fields
4. Seed script uses upserts for idempotency
5. Health check imports prisma client and queries database
6. Health check returns database status in response body
7. package.json contains prisma.seed configuration
</verification>

<success_criteria>
- 25 California districts seeded with demographics, proficiency, and funding data
- Default tenant and admin user seeded for development
- Seed script is idempotent (safe to run multiple times)
- Health check endpoint reports database connectivity (AUTH-03)
- Health check returns 200 when DB is up, 503 when DB is down
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-data-layer/02-03-SUMMARY.md`
</output>
