---
phase: 03-discovery-district-profiles
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/districts/[districtId]/page.tsx
  - src/components/district/demographics-section.tsx
  - src/components/district/proficiency-section.tsx
  - src/components/district/funding-section.tsx
  - src/components/district/fit-assessment-panel.tsx
  - src/components/district/data-field.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a district profile with name, location, county, and enrollment"
    - "User can see demographics data rendered as labeled percentage bars"
    - "User can see proficiency data for Math, ELA, Science"
    - "User can see funding data with formatted currency values"
    - "User can select products and see fit assessment (strong/moderate/low)"
    - "All data fields render dynamically based on what the district has"
  artifacts:
    - path: "src/app/(dashboard)/districts/[districtId]/page.tsx"
      provides: "District profile page fetching and rendering all district data"
      min_lines: 50
    - path: "src/components/district/demographics-section.tsx"
      provides: "Demographics data display with percentage bars"
      exports: ["DemographicsSection"]
    - path: "src/components/district/proficiency-section.tsx"
      provides: "Proficiency data display for academic subjects"
      exports: ["ProficiencySection"]
    - path: "src/components/district/funding-section.tsx"
      provides: "Funding data display with formatted currency"
      exports: ["FundingSection"]
    - path: "src/components/district/fit-assessment-panel.tsx"
      provides: "Product selection and fit assessment display"
      exports: ["FitAssessmentPanel"]
    - path: "src/components/district/data-field.tsx"
      provides: "Generic data field renderer for dynamic key-value pairs"
      exports: ["DataField"]
  key_links:
    - from: "src/app/(dashboard)/districts/[districtId]/page.tsx"
      to: "/api/districts/[districtId]"
      via: "server-side fetch or direct service call"
      pattern: "(fetch.*api/districts|getDistrict)"
    - from: "src/components/district/fit-assessment-panel.tsx"
      to: "/api/districts/[districtId]/fit"
      via: "client-side fetch on product selection"
      pattern: "fetch.*fit"
---

<objective>
Build the district profile page that displays comprehensive district data (demographics, proficiency, funding) and allows users to assess product-district fit.

Purpose: Sales reps need to view detailed district information before meetings. The profile page turns raw data into actionable intelligence. Dynamic rendering ensures all available data fields are shown without hardcoding.

Output: 6 files - 1 page component + 5 UI components
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/services/types/district.ts
@src/services/types/common.ts
@src/services/types/product.ts
@src/services/types/controlled-vocabulary.ts
@src/app/(dashboard)/districts/[districtId]/page.tsx
@prisma/seed.ts
@.planning/phases/03-discovery-district-profiles/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create district profile display components</name>
  <files>
src/components/district/data-field.tsx
src/components/district/demographics-section.tsx
src/components/district/proficiency-section.tsx
src/components/district/funding-section.tsx
src/components/district/fit-assessment-panel.tsx
  </files>
  <action>
Create five components in `src/components/district/`. Use Tailwind classes consistent with the project design system.

**DataField (data-field.tsx)**
- NOT a client component (server-safe, no 'use client')
- Props: `{ label: string; value: string | number; format?: 'number' | 'currency' | 'percent' | 'text' }`
- Render a label-value pair. Format value based on `format`:
  - 'number': toLocaleString() (e.g., 422,276)
  - 'currency': toLocaleString('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }) (e.g., $16,890)
  - 'percent': `${value}%`
  - 'text' or default: string as-is
- Styling: label in text-sm text-muted-foreground, value in text-base font-medium text-foreground

**DemographicsSection (demographics-section.tsx)**
- NOT a client component
- Props: `{ demographics: Record<string, number> }`
- Section header: "Demographics" (text-lg font-semibold font-heading)
- Iterate over Object.entries(demographics), sorted by value descending
- For each entry render: label, percentage value, and a horizontal bar visualization
  - Bar: relative div with bg-muted rounded-full h-2.5, inner div with bg-primary rounded-full h-2.5 and width as percentage of max value (so the largest group fills the bar fully, others proportional)
  - Label and value on same line above bar: flex justify-between, label left, "{value}%" right
- Handles empty demographics gracefully with "No demographics data available" message

**ProficiencySection (proficiency-section.tsx)**
- NOT a client component
- Props: `{ proficiency: Record<string, number> }`
- Section header: "Academic Proficiency" (text-lg font-semibold font-heading)
- Iterate over Object.entries(proficiency)
- For each subject: render subject name, percentage, and a color-coded bar
  - Bar color based on value: >= 50 -> bg-green-500 (meeting standards), 35-49 -> bg-yellow-500 (approaching), < 35 -> bg-red-500 (below)
  - Bar width as percentage of 100 (proficiency is already a percentage)
  - Label: subject name left, "{value}% Proficient" right
- Handles empty proficiency gracefully

**FundingSection (funding-section.tsx)**
- NOT a client component
- Props: `{ funding: Record<string, number> }`
- Section header: "Funding" (text-lg font-semibold font-heading)
- Iterate over Object.entries(funding)
- Use DataField component for each entry
- Detect format heuristically: if key contains "Per Pupil" or value < 100000, use 'currency'. If value >= 100000, also use 'currency' (all funding values are currency in our seed data)
- Display in a 2-column grid (grid-cols-2 gap-4) for desktop
- Handles empty funding gracefully

**FitAssessmentPanel (fit-assessment-panel.tsx)**
- Mark as `'use client'` (manages state for product selection and API calls)
- Props: `{ districtId: string }`
- State: `selectedProductIds` (string[]), `assessment` (FitAssessment | null), `loading` (boolean), `products` (ProductSummary[] for product list — for MVP, since we have no products seeded yet, show a placeholder message: "No products available. Add products in Solutions Library to assess fit." If products exist, show checkboxes)
- On mount: fetch product list from `/api/products` (this endpoint doesn't exist yet — handle 404 gracefully by showing the placeholder message)
- When user clicks "Assess Fit" button (disabled unless at least 1 product selected):
  - Fetch `GET /api/districts/${districtId}/fit?productIds=${selectedProductIds.join(',')}`
  - Display result: fitCategory badge (color-coded: strong=green, moderate=yellow, low=red) + fitRationale text
- Badge styling: inline-flex px-3 py-1 rounded-full text-sm font-medium. Colors: strong -> bg-green-100 text-green-800, moderate -> bg-yellow-100 text-yellow-800, low -> bg-red-100 text-red-800
- Section header: "Product-District Fit Assessment" (text-lg font-semibold font-heading)
- Styling: border rounded-lg p-6 bg-card. Assessment result in a separate bordered section below button

Import types from `@/services` barrel export where possible. Import ProductSummary from `@/services/types/product`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds. Verify all five component files exist in `src/components/district/`.
  </verify>
  <done>
Five district profile components exist: DataField for generic key-value display, DemographicsSection with percentage bars, ProficiencySection with color-coded proficiency bars, FundingSection with formatted currency, and FitAssessmentPanel with product selection and fit category display. All compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build district profile page</name>
  <files>src/app/(dashboard)/districts/[districtId]/page.tsx</files>
  <action>
Replace the stub district profile page with a server component that fetches and displays comprehensive district data.

**Data fetching approach:** Use direct service function call (server component can import district-service directly since it runs on the server). Import `getDistrict` from `@/services/district-service`. This avoids an unnecessary API round-trip. The page IS a server component (no 'use client').

**Page structure:**
- Async server component: `export default async function DistrictProfilePage({ params })`
- Extract districtId from params (Next.js 15 async pattern: `const { districtId } = await params`)
- Call `getDistrict(districtId)` in a try/catch
- On error: use `notFound()` from `next/navigation` to render 404 page

**Layout:**
- Back link at top: "< Back to Discovery" using Link to `/discovery`. Styled with text-sm text-muted-foreground hover:text-foreground flex items-center gap-1 with ArrowLeft icon (lucide-react)
- Header section: District name (h1, text-2xl font-bold font-heading), location + county below (text-muted-foreground), enrollment count formatted (e.g., "422,276 students") as a badge-like element
- Below header: Three-section layout using a single column with gap-8 between sections:
  1. DemographicsSection (passing district.demographics)
  2. ProficiencySection (passing district.proficiency)
  3. FundingSection (passing district.funding)
- After the three data sections: FitAssessmentPanel (client component, passing districtId)
- If district.additionalData exists and has keys, render an "Additional Data" section using DataField for each entry

**Metadata:** Export `generateMetadata` function that returns `{ title: district.name }` for browser tab title. Handle errors gracefully (return generic title on failure).

Import components from `@/components/district/`. Import `getDistrict` from `@/services/district-service`. Import `notFound` from `next/navigation`. Import `Link` from `next/link`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds. Verify the page imports getDistrict from district-service (server-side call, no fetch). Verify it renders DemographicsSection, ProficiencySection, FundingSection, and FitAssessmentPanel. Verify it uses notFound() for error handling.
  </verify>
  <done>
District profile page fetches data server-side via getDistrict, renders all three data sections (demographics with bars, proficiency with color coding, funding with currency formatting), includes fit assessment panel, handles unknown districts with 404, and dynamically renders any additionalData fields. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0
2. All six files exist at correct paths
3. District profile page calls getDistrict server-side (not fetch)
4. DemographicsSection renders all demographic entries dynamically (not hardcoded)
5. ProficiencySection color-codes bars based on proficiency level
6. FundingSection formats values as currency
7. FitAssessmentPanel fetches from /api/districts/[districtId]/fit
8. Back link navigates to /discovery
9. notFound() called when district doesn't exist
</verification>

<success_criteria>
- District profile page displays all available data for any seeded district
- Demographics, proficiency, and funding sections render dynamically from JSONB data
- Proficiency bars are color-coded (green/yellow/red) based on performance level
- Funding values display as formatted currency
- Fit assessment panel allows product selection and shows assessment results
- Unknown district IDs show 404 page
- Back navigation returns to Discovery page
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-district-profiles/03-03-SUMMARY.md`
</output>
