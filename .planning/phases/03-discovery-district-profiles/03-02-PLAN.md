---
phase: 03-discovery-district-profiles
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/app/(dashboard)/discovery/page.tsx
  - src/components/discovery/search-bar.tsx
  - src/components/discovery/filter-sidebar.tsx
  - src/components/discovery/district-result-card.tsx
  - src/components/discovery/pagination.tsx
autonomous: true

must_haves:
  truths:
    - "User can type a search query and see matching California districts"
    - "User can filter districts by county and enrollment range"
    - "Filter facets are loaded dynamically from the API"
    - "Search results display district name, location, enrollment in card format"
    - "Results are paginated with page navigation controls"
  artifacts:
    - path: "src/app/(dashboard)/discovery/page.tsx"
      provides: "Discovery search page with search, filters, and results"
      min_lines: 40
    - path: "src/components/discovery/search-bar.tsx"
      provides: "Search input component with debounced query"
      exports: ["SearchBar"]
    - path: "src/components/discovery/filter-sidebar.tsx"
      provides: "Filter panel with county multi-select and enrollment range"
      exports: ["FilterSidebar"]
    - path: "src/components/discovery/district-result-card.tsx"
      provides: "District search result card with link to profile"
      exports: ["DistrictResultCard"]
    - path: "src/components/discovery/pagination.tsx"
      provides: "Page navigation controls"
      exports: ["Pagination"]
  key_links:
    - from: "src/app/(dashboard)/discovery/page.tsx"
      to: "/api/districts"
      via: "fetch in client component"
      pattern: "fetch.*api/districts"
    - from: "src/components/discovery/filter-sidebar.tsx"
      to: "/api/districts/filters"
      via: "fetch on mount"
      pattern: "fetch.*api/districts/filters"
    - from: "src/components/discovery/district-result-card.tsx"
      to: "/districts/[districtId]"
      via: "Next.js Link component"
      pattern: "href.*districts/"
---

<objective>
Build the Discovery search page where users can search California districts by name, apply filters (county, enrollment), and browse paginated results.

Purpose: This is the primary entry point for sales reps to find districts. It replaces the stub Discovery page with a functional search interface connected to the district API from Plan 03-01.

Output: 5 files - 1 page component + 4 UI components
</objective>

<execution_context>
@/Users/dorenberge/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dorenberge/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/services/types/district.ts
@src/services/types/common.ts
@src/app/(dashboard)/discovery/page.tsx
@src/app/(dashboard)/layout.tsx
@src/components/layout/sidebar.tsx
@.planning/phases/03-discovery-district-profiles/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create discovery UI components</name>
  <files>
src/components/discovery/search-bar.tsx
src/components/discovery/filter-sidebar.tsx
src/components/discovery/district-result-card.tsx
src/components/discovery/pagination.tsx
  </files>
  <action>
Create four client-side components in `src/components/discovery/`. All marked with `'use client'`. Use Tailwind classes consistent with existing sidebar styling (text-foreground, bg-card, border, etc.). Use lucide-react icons where appropriate.

**SearchBar (search-bar.tsx)**
- Props: `{ value: string; onChange: (query: string) => void }`
- Render an input with Search icon (lucide-react), placeholder "Search California districts..."
- Debounce onChange by 300ms using a useEffect with setTimeout/clearTimeout pattern (no external debounce library)
- Styling: Full-width input with px-4 py-2.5, rounded-lg border, focus ring with ring-primary, bg-background text-foreground

**FilterSidebar (filter-sidebar.tsx)**
- Props: `{ filters: Record<string, string | number | string[]>; onFiltersChange: (filters: Record<string, string | number | string[]>) => void; facets: FilterFacet[] }`
- Render filter sections based on facets array:
  - For "multi-select" type (county): Render a list of checkboxes with label and count badge. Show "All Counties" as default. When checked/unchecked, update filters.county as string[] and call onFiltersChange
  - For "range" type (enrollment): Render two number inputs (Min / Max) side by side. On change, update filters.enrollmentMin / filters.enrollmentMax and call onFiltersChange
- Include a "Clear Filters" button at the bottom that resets all filters to empty
- Styling: Vertical stack with section headers (font-medium text-sm uppercase tracking-wider text-muted-foreground). Each section in a border-b pb-4 mb-4 block. Checkboxes with gap-2 flex items-center. County list scrollable with max-h-64 overflow-y-auto

**DistrictResultCard (district-result-card.tsx)**
- Props: `{ district: DistrictSummary }`
- Import DistrictSummary from `@/services/types/district`
- Render a card linking to `/districts/${district.districtId}` using Next.js Link
- Display: district name (font-semibold text-lg), location (text-muted-foreground text-sm), enrollment formatted with toLocaleString() (e.g., "422,276 students")
- Include a right-pointing chevron icon (ChevronRight from lucide-react) to indicate clickability
- Styling: bg-card border rounded-lg p-4 hover:border-primary/50 hover:shadow-sm transition-all cursor-pointer. Use flex justify-between items-center layout

**Pagination (pagination.tsx)**
- Props: `{ page: number; totalPages: number; onPageChange: (page: number) => void }`
- Render: Previous button, page info text ("Page X of Y"), Next button
- Previous disabled when page === 1, Next disabled when page === totalPages
- Styling: flex items-center justify-center gap-4. Buttons with px-3 py-1.5 rounded-md border. Disabled buttons with opacity-50 cursor-not-allowed. Active buttons with hover:bg-accent

All components import types from `@/services/types/district` and `@/services/types/common` as needed.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds. Verify all four component files exist in `src/components/discovery/`.
  </verify>
  <done>
Four discovery UI components exist: SearchBar with debounced input, FilterSidebar rendering dynamic facets (county checkboxes, enrollment range inputs), DistrictResultCard linking to profile pages, and Pagination with prev/next navigation. All compile without TypeScript errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire discovery page with search, filters, and results</name>
  <files>src/app/(dashboard)/discovery/page.tsx</files>
  <action>
Replace the stub Discovery page with a fully functional search interface. Mark as `'use client'` since it manages search state.

**State management:**
- `searchQuery` (string, default "")
- `filters` (Record<string, string | number | string[]>, default {})
- `page` (number, default 1)
- `results` (PaginatedResponse<DistrictSummary> | null)
- `facets` (FilterFacet[], default [])
- `loading` (boolean, default false)
- `error` (string | null)

**Data fetching:**
- Use useEffect to fetch results whenever searchQuery, filters, or page changes
- Build URL: `/api/districts?q=${searchQuery}&page=${page}&pageSize=25` + append county and enrollment params from filters
- For county filter: if filters.county is string[], join with comma: `&county=Los Angeles,Orange`
- For enrollment: `&enrollmentMin=X&enrollmentMax=Y` if present
- Set loading=true before fetch, false after, catch errors into error state
- On successful response, set results

- Use separate useEffect to fetch facets on mount: `GET /api/districts/filters`
- Set facets from response

**Reset page to 1** when searchQuery or filters change (separate useEffect or inline).

**Layout:**
- Page title: "Discovery & Targeting" (h1, font-heading)
- Subtitle: "Search California districts and build your territory."
- Below title: SearchBar component
- Below search bar: Two-column layout using CSS grid (grid-cols-[280px_1fr] gap-6)
  - Left column: FilterSidebar with facets and current filters
  - Right column: Results area
    - If loading: Show "Searching..." text with muted styling
    - If error: Show error message in red
    - If results with items: Grid of DistrictResultCard components (1 column, gap-3), then Pagination below
    - If results with 0 items: "No districts found matching your search." message
    - If no results yet (initial): "Enter a search term or browse all districts." prompt

- On initial load (empty search), still fetch all districts (empty query returns all, paginated)

Import all four components from `@/components/discovery/`. Import types from `@/services/types/district` and `@/services/types/common`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compilation succeeds. Verify the discovery page imports and uses all four discovery components. Verify fetch calls target `/api/districts` and `/api/districts/filters`.
  </verify>
  <done>
Discovery page renders SearchBar, FilterSidebar, result cards, and Pagination. Searching by name filters results. County and enrollment filters work. Pagination navigates between pages. Page resets to 1 when search/filters change. Loading and error states display correctly. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` exits 0
2. All five files exist at correct paths
3. Discovery page fetches from `/api/districts` and `/api/districts/filters`
4. DistrictResultCard links to `/districts/${districtId}` (connecting to profile page)
5. FilterSidebar renders facets dynamically (not hardcoded county list)
6. SearchBar debounces input (300ms delay)
7. Pagination controls are present with prev/next
</verification>

<success_criteria>
- Discovery page replaces the stub with functional search interface
- Users can search districts by name and see paginated results
- Users can filter by county (multi-select) and enrollment range
- Filter facets are loaded dynamically from the API
- Each result card links to the district profile page
- Page navigation works correctly
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-discovery-district-profiles/03-02-SUMMARY.md`
</output>
